# APE (Agentic Pipeline Engine) 확장 설계 문서

## 1. 프로젝트 개요

APE(Agentic Pipeline Engine)는 VS Code 확장 프로그램으로, 개발자들이 인공지능 모델을 활용하여 효율적으로 코딩할 수 있도록 지원하는 도구입니다. 본 설계 문서는 APE의 기능 개선 및 확장 계획을 상세히 기술합니다.

### 1.1 목표

- 개발자의 생산성 향상을 위한 직관적이고 미니멀한 인터페이스 제공
- VS Code의 네이티브 경험을 해치지 않는 통합된 사용자 경험 설계
- 사용자 입력을 최소화하고 자동화 기능 극대화
- 로컬 자원과 LLM 연계 기능의 명확한 분리
- 문맥 관리 및 지식 저장을 위한 체계적인 시스템 구축

### 1.2 현재 상황 분석

현재 APE 확장은 다음과 같은 기능과 이슈를 가지고 있습니다:

- Git 명령어가 로컬 명령과 API 호출 방식으로 혼재되어 있음
- UI에 스크롤 중첩 문제 발생
- 사용자 입력에 의존하는 명령어 구조
- 채팅 세션 관리 기능 부재
- 문서 및 룰 관리 시스템 부재

## 2. 주요 기능 설계

### 2.1 Git 명령어 시스템 개선

#### 2.1.1 문제점
- 현재 Git 관련 기능이 로컬 명령과 API 호출 기능이 혼재되어 있어 사용자에게 혼란을 줌
- 터미널에서 직접 수행하는 것이 더 효율적인 기능들이 포함되어 있음

#### 2.1.2 개선 방향
- **분리 원칙**: 
  - 로컬 Git 명령은 터미널로 위임
  - LLM을 활용한 고급 Git 서비스만 `@git` 명령으로 제공

- **제공 기능**:
  - `@git:summarize` - 현재 브랜치의 변경사항 요약
  - `@git:commit-message` - 변경사항 분석 후 적절한 커밋 메시지 제안
  - `@git:explain-diff` - 특정 파일/커밋의 변경사항 설명
  - `@git:review-pr` - PR 코드 리뷰 자동화
  - `@git:conflict-resolve` - 충돌 해결 지원

#### 2.1.3 구현 고려사항
- Git 명령 결과를 캐싱하여 반복적인 명령 최소화
- API 엔드포인트 호출 전 로컬 `.git` 정보를 최대한 활용
- Git 설정 자동 감지 및 통합

### 2.2 UI/UX 개선

#### 2.2.1 문제점
- 복잡한 인터페이스로 인한 사용성 저하
- 스크롤 내 스크롤 중첩 문제
- 화면 공간 효율성 저하

#### 2.2.2 개선 방향
- **미니멀 디자인**:
  - 불필요한 UI 요소 제거
  - VS Code의 기본 디자인 시스템과 일관성 유지
  - 가독성 중심의 타이포그래피

- **스크롤 문제 해결**:
  - 단일 스크롤 컨테이너 구조로 개선
  - 가상화(Virtualization) 기법 적용하여 대규모 채팅도 성능 보장
  - 반응형 레이아웃 적용

- **인터랙션 개선**:
  - 드래그 앤 드롭 지원
  - 키보드 단축키 체계화
  - 문맥 메뉴(Context Menu) 최적화

#### 2.2.3 구현 고려사항
- VS Code의 WebView API 활용 최적화
- CSS Grid 및 Flexbox를 활용한 레이아웃 구성
- 스크롤 성능 최적화를 위한 기법 적용

### 2.3 트리뷰 구조 도입

#### 2.3.1 설계 원칙
- VS Code의 기본 Explorer 기능 활용 및 확장
- 네이티브 사용자 경험 유지
- 표준 파일 시스템 작업 지원 (새 파일 생성, 삭제, 이름 변경 등)

#### 2.3.2 트리뷰 구성
- **레벨 1**: 주요 카테고리
  - 채팅 (기본 선택)
  - 세션 히스토리
  - Vault
  - Rules

- **레벨 2 이하**: 각 카테고리별 하위 항목
  - 채팅: 현재 활성화된 채팅 모드
  - 세션 히스토리: 날짜별/주제별 세션 목록
  - Vault: 폴더/파일 구조 (VS Code 파일 시스템 통합)
  - Rules: 룰 카테고리 및 개별 룰 (활성 상태 표시)

#### 2.3.3 구현 고려사항
- VS Code의 TreeDataProvider API와 FileSystemProvider API 활용
- VS Code 기본 명령어 지원 (Reveal in Explorer, New File, Delete 등)
- 컨텍스트 메뉴에 특화 기능 추가 (Rules 활성화/비활성화 등)
- 활성화된 Rules는 시각적으로 구분 (아이콘, 색상 또는 체크마크)

### 2.4 Chat Session 히스토리 기능

#### 2.4.1 기능 정의
- 과거 채팅 세션의 저장, 조회, 관리 기능
- 세션별 메타데이터 관리
- 세션 간 컨텍스트 공유 기능

#### 2.4.2 구현 방안
- **저장 구조**:
  - JSON 형식 기반 세션 데이터 구조
  - 세션 메타데이터: 제목, 생성일, 태그, 요약 등
  - 메시지 데이터: 발신자, 내용, 타임스탬프, 참조 등

- **기능**:
  - 세션 자동 저장
  - 세션 검색 (키워드, 날짜, 태그 기반)
  - 세션 불러오기
  - 세션 결합 및 분할

#### 2.4.3 구현 고려사항
- 효율적인 세션 데이터 압축 및 저장
- 대용량 세션 히스토리 처리 방안
- 세션 간 컨텍스트 연속성 유지

### 2.5 Vault 시스템

#### 2.5.1 기능 정의
- VS Code 기본 파일 시스템 기능을 활용한 문서 관리 시스템
- 마크다운 기반 노트 저장 및 관리
- 채팅 세션과 통합된 자동 저장 기능

#### 2.5.2 구현 방안
- **저장소 구조**:
  - VS Code Explorer와 동일한 기본 기능 제공
  - 사용자 정의 루트 디렉토리 설정 기능
  - 기본 루트 디렉토리 제공
  - 표준 파일 시스템 작업 지원 (새 파일, 삭제, 이름 변경 등)

- **노트 관리 기능**:
  - VS Code 기본 마크다운 뷰어/에디터 활용
  - 표준 파일 작업 명령어 지원
  - VS Code 기본 검색 기능 통합

- **채팅 통합**:
  - 채팅 내용 선택적 저장
  - 중요 정보 자동 추출 및 저장

#### 2.5.3 구현 고려사항
- VS Code의 FileSystemProvider API 활용
- 기본 VS Code 기능의 재사용을 통한 개발 효율화
- 향후 기능 확장을 위한 Obsidian 기능 벤치마킹 (TODO)

### 2.6 APE Rules 기능

#### 2.6.1 기능 정의
- Claude.md, Clinerules, Cursorrules와 유사한 시스템 프롬프트 관리
- 룰 생성, 편집, 활성화 기능
- 프로젝트별 룰 설정 기능

#### 2.6.2 구현 방안
- **룰 구조**:
  - 마크다운 기반 룰 정의
  - 메타데이터 섹션 포함
  - 컨텍스트 조건 정의 가능

- **룰 관리**:
  - VS Code Explorer와 유사한 기본 파일 시스템 기능 활용
  - 트리뷰에서 룰 파일 표시 및 관리
  - 컨텍스트 메뉴를 통한 활성화/비활성화 토글
  - 활성화된 룰은 시각적으로 구분되어 표시

- **룰 적용**:
  - 쿼리 전송 시 활성 룰 자동 적용
  - 룰 합성 및 충돌 해결 로직
  - 룰 효과 가시화

#### 2.6.3 구현 고려사항
- VS Code 파일 시스템 통합
- 표준 파일 작업 지원 (Reveal in Explorer, New, Delete, Edit)
- 룰 상태 관리 및 시각적 표현
- 룰 템플릿 및 예제 제공

### 2.7 @doc 명령어 시스템

#### 2.7.1 기능 정의
- APE-Core 호스트와 통신하여 RAG(Retrieval-Augmented Generation) 문서 관리
- 문서 검색, 추가, 삭제 기능
- 채팅 쿼리에 문서 컨텍스트 통합

#### 2.7.2 구현 방안
- **명령어 체계**:
  - `@doc:add` - 문서 추가
  - `@doc:search` - 문서 검색
  - `@doc:list` - 문서 목록 조회
  - `@doc:delete` - 문서 삭제
  - `@doc:use` - 쿼리에 특정 문서 컨텍스트 활용

- **통합 방식**:
  - APE-Core 호스트 API 엔드포인트(`http://localhost:8001/agents/rag`) 활용
  - RESTful API 호출:
    ```bash
    curl -X POST http://localhost:8001/agents/rag \
      -H "Content-Type: application/json" \
      -d '{
        "query": "쿼리문",
        "streaming": false
      }'
    ```
  - 문서 메타데이터 캐싱
  - 효율적인 문서 전송 프로토콜

#### 2.7.3 구현 고려사항
- API 요청 최적화 및 캐싱
- 대용량 문서 처리 방안
- 문서 보안 및 접근 제어
- 내부 API 엔드포인트 구성을 위한 설정 기능

## 3. 아키텍처 설계

### 3.1 전체 시스템 구조

```
APE Extension
│
├── Core
│   ├── ApeCoreService                 # 핵심 서비스 조정
│   ├── CommandService                 # 명령어 처리
│   ├── LLMService                     # LLM 통신
│   └── ConfigService                  # 설정 관리
│
├── Features
│   ├── GitFeature                     # Git 관련 기능
│   ├── VaultFeature                   # Vault 관리
│   ├── RulesFeature                   # APE Rules 관리
│   ├── DocFeature                     # 문서 관리
│   └── SessionFeature                 # 채팅 세션 관리
│
├── UI
│   ├── ChatView                       # 채팅 인터페이스
│   ├── TreeView                       # 트리뷰 관리
│   ├── StatusBar                      # 상태 표시줄
│   └── SettingsView                   # 설정 인터페이스
│
└── Data
    ├── SessionStorage                 # 세션 데이터 관리
    ├── VaultStorage                   # Vault 데이터 관리
    ├── RulesStorage                   # Rules 데이터 관리
    └── CacheManager                   # 캐싱 시스템
```

### 3.2 데이터 흐름 설계

1. **사용자 입력 흐름**:
   - 사용자 입력 → 명령어 파싱 → 기능 라우팅 → 실행 → 결과 표시

2. **설정 관리 흐름**:
   - VS Code 설정 → ConfigService → 각 기능 모듈 → 기능 동작 조정

3. **LLM 통신 흐름**:
   - 사용자 쿼리 → 활성 Rules 적용 → LLMService → API 호출 → 결과 처리 → UI 표시

4. **데이터 저장 흐름**:
   - 데이터 변경 → 관련 Storage 모듈 → 파일 시스템/API 저장 → 캐싱

### 3.3 모듈 간 의존성

- **Core 모듈**: 다른 모든 모듈에 의존성 제공
- **Feature 모듈**: Core 모듈과 Data 모듈에 의존
- **UI 모듈**: Core 모듈과 Feature 모듈에 의존
- **Data 모듈**: Core 모듈에만 의존

## 4. 기술적 구현 고려사항

### 4.1 VS Code API 활용

- **WebView API**: 채팅 인터페이스 및 문서 편집기 구현
- **TreeView API**: 트리뷰 구조 구현
- **FileSystem API**: Vault 및 Rules 파일 관리
- **Configuration API**: 사용자 설정 관리
- **StatusBar API**: 상태 표시 및 빠른 액션 제공

### 4.2 성능 최적화

- **데이터 캐싱**: LLM 응답, Git 정보, 문서 메타데이터 등 캐싱
- **비동기 처리**: 모든 I/O 작업의 비동기 처리
- **가상화**: 대용량 데이터 표시를 위한 UI 가상화
- **증분 갱신**: 부분 데이터 업데이트를 통한 렌더링 최적화

### 4.3 확장성 고려

- **플러그인 아키텍처**: 새로운 기능을 플러그인 형태로 추가 가능한 구조
- **이벤트 시스템**: 모듈 간 느슨한 결합을 위한 이벤트 기반 통신
- **설정 체계**: 세부 조정 가능한 설정 시스템

### 4.4 보안 고려사항

- **API 키 관리**: 안전한 API 키 저장 및 관리
- **데이터 암호화**: 민감한 정보의 로컬 암호화
- **접근 제어**: 기능별 적절한 권한 관리

## 5. 질문 및 명확화가 필요한 사항

1. **APE-Core 호스트 통신**
   - APE-Core 호스트의 API 엔드포인트 및 인증 방식
   - 지원하는 API 기능 목록
   - 통신 프로토콜 상세

2. **Vault 시스템 요구사항**
   - 지원해야 할 마크다운 문법 범위
   - 백링크 및 참조 시스템 구현 수준
   - Obsidian 플러그인과의 호환성 필요 여부

3. **Rules 시스템**
   - 룰 적용 우선순위 및 충돌 해결 정책
   - 룰 템플릿 필요 여부
   - 프로젝트별 룰 분리 방식

4. **확장 설치 환경**
   - 지원해야 할 VS Code 최소 버전
   - 오프라인 환경 지원 필요 여부
   - 다중 작업 공간(Multi-root workspace) 지원 범위

## 6. 마일스톤 및 단계적 구현 계획

### 6.1 1단계: 기반 구조 개선
- UI/UX 개선 및 스크롤 문제 해결
- 트리뷰 기본 구조 구현
- 설정 자동화 기능 구현

### 6.2 2단계: 핵심 기능 구현
- Git 명령어 시스템 개선
- 세션 히스토리 기본 기능
- APE Rules 기본 기능

### 6.3 3단계: 확장 기능 구현
- Vault 시스템 구현
- @doc 명령어 시스템 구현
- 고급 세션 관리 기능

### 6.4 4단계: 최적화 및 안정화
- 성능 최적화
- 테스트 및 버그 수정
- 문서화 및 사용자 가이드 작성

## 7. 결론

이 설계 문서는 APE 확장의 개선 방향을 제시합니다. 비판적 관점에서 현재 시스템의 문제점을 분석하고, 사용자 중심의 솔루션을 설계했습니다. 구현 과정에서 추가적인 질문과 검토를 통해 더욱 견고한 시스템을 구축할 것을 제안합니다.

## 8. 참고 자료

- VS Code 확장 API 문서: [https://code.visualstudio.com/api](https://code.visualstudio.com/api)
- Obsidian 기능 참조: [https://obsidian.md/features](https://obsidian.md/features)
- Claude.md 참조: [https://claude.ai/docs/claude-md](https://claude.ai/docs/claude-md)