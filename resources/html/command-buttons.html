<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src ${cspSource} 'unsafe-inline'; script-src ${cspSource} 'unsafe-inline'; font-src ${cspSource};">
  <title>APE 명령어 패널</title>
  <link href="${commandButtonsCssUri}" rel="stylesheet">
  <link href="${codiconsUri}" rel="stylesheet">
  <link href="${claudeStyleCssUri}" rel="stylesheet">
  <link href="${apeIconsCssUri}" rel="stylesheet">
  <!-- 아이콘용 CSS -->
  <link href="${phosphorIconsCssUri}" rel="stylesheet">
</head>
<body class="command-panel-body">
  <div class="command-panel-container">
    <!-- 상단 제목 및 컨트롤 -->
    <div class="command-panel-header">
      <h2 class="command-panel-title">
        <i class="ph ph-terminal"></i>
        <span>APE 명령어 패널</span>
      </h2>
      <div class="command-panel-actions">
        <button class="command-panel-action" id="toggleFrequent" title="자주 사용하는 명령어만 표시">
          <i class="ph ph-star"></i>
        </button>
        <button class="command-panel-action" id="refreshCommands" title="명령어 목록 새로고침">
          <i class="ph ph-arrows-clockwise"></i>
        </button>
        <button class="command-panel-action" id="toggleHelpMode" title="도움말 모드 켜기/끄기">
          <i class="ph ph-question"></i>
        </button>
      </div>
    </div>
    
    <!-- 검색 필터 -->
    <div class="command-search-container">
      <div class="search-input-wrapper">
        <i class="ph ph-magnifying-glass search-icon"></i>
        <input type="text" id="commandSearch" placeholder="명령어 검색..." class="command-search-input">
        <button class="clear-search-button" id="clearSearch" title="검색 지우기">
          <i class="ph ph-x"></i>
        </button>
      </div>
    </div>
    
    <!-- 자주 사용하는 명령어 -->
    <div class="command-section" id="frequent-section">
      <div class="command-section-header" onclick="toggleCommandSection('frequent-commands')">
        <div class="header-title">
          <i class="ph ph-star section-icon" data-weight="fill"></i>
          <h3>자주 사용하는 명령어</h3>
        </div>
        <div class="header-controls">
          <span class="command-count" id="frequent-count">0</span>
          <span class="toggle-icon ph ph-caret-down" id="frequent-commands-toggle"></span>
        </div>
      </div>
      <div class="commands-container" id="frequent-commands">
        <div class="empty-commands">자주 사용하는 명령어가 없습니다.</div>
      </div>
    </div>
    
    <!-- 시스템 명령어 섹션 (/ 명령어) -->
    <div class="command-section" id="system-section">
      <div class="command-section-header" onclick="toggleCommandSection('system-commands')">
        <div class="header-title">
          <i class="ph ph-gear-six section-icon"></i>
          <h3>시스템 명령어</h3>
        </div>
        <div class="header-controls">
          <span class="command-count" id="system-count">0</span>
          <span class="toggle-icon ph ph-caret-down" id="system-commands-toggle"></span>
        </div>
      </div>
      <div class="commands-container" id="system-commands">
        <div class="empty-commands">명령어를 로드하는 중...</div>
      </div>
    </div>
    
    <!-- Git 명령어 -->
    <div class="command-section" id="git-section">
      <div class="command-section-header" onclick="toggleCommandSection('git-commands')">
        <div class="header-title">
          <i class="ph ph-git-branch section-icon"></i>
          <h3>Git 명령어</h3>
        </div>
        <div class="header-controls">
          <span class="command-count" id="git-count">0</span>
          <span class="toggle-icon ph ph-caret-down" id="git-commands-toggle"></span>
        </div>
      </div>
      <div class="commands-container" id="git-commands">
        <div class="empty-commands">명령어를 로드하는 중...</div>
      </div>
    </div>
    
    <!-- 문서 명령어 -->
    <div class="command-section" id="doc-section">
      <div class="command-section-header" onclick="toggleCommandSection('doc-commands')">
        <div class="header-title">
          <i class="ph ph-file-text section-icon"></i>
          <h3>문서 명령어</h3>
        </div>
        <div class="header-controls">
          <span class="command-count" id="doc-count">0</span>
          <span class="toggle-icon ph ph-caret-down" id="doc-commands-toggle"></span>
        </div>
      </div>
      <div class="commands-container" id="doc-commands">
        <div class="empty-commands">명령어를 로드하는 중...</div>
      </div>
    </div>
    
    <!-- Jira 명령어 -->
    <div class="command-section" id="jira-section">
      <div class="command-section-header" onclick="toggleCommandSection('jira-commands')">
        <div class="header-title">
          <i class="ph ph-kanban section-icon"></i>
          <h3>Jira 명령어</h3>
        </div>
        <div class="header-controls">
          <span class="command-count" id="jira-count">0</span>
          <span class="toggle-icon ph ph-caret-down" id="jira-commands-toggle"></span>
        </div>
      </div>
      <div class="commands-container" id="jira-commands">
        <div class="empty-commands">명령어를 로드하는 중...</div>
      </div>
    </div>
    
    <!-- Pocket 명령어 -->
    <div class="command-section" id="pocket-section">
      <div class="command-section-header" onclick="toggleCommandSection('pocket-commands')">
        <div class="header-title">
          <i class="ph ph-archive-box section-icon"></i>
          <h3>Pocket 명령어</h3>
        </div>
        <div class="header-controls">
          <span class="command-count" id="pocket-count">0</span>
          <span class="toggle-icon ph ph-caret-down" id="pocket-commands-toggle"></span>
        </div>
      </div>
      <div class="commands-container" id="pocket-commands">
        <div class="empty-commands">명령어를 로드하는 중...</div>
      </div>
    </div>
    
    <!-- Vault 명령어 -->
    <div class="command-section" id="vault-section">
      <div class="command-section-header" onclick="toggleCommandSection('vault-commands')">
        <div class="header-title">
          <i class="ph ph-database section-icon"></i>
          <h3>Vault 명령어</h3>
        </div>
        <div class="header-controls">
          <span class="command-count" id="vault-count">0</span>
          <span class="toggle-icon ph ph-caret-down" id="vault-commands-toggle"></span>
        </div>
      </div>
      <div class="commands-container" id="vault-commands">
        <div class="empty-commands">명령어를 로드하는 중...</div>
      </div>
    </div>
    
    <!-- Rules 명령어 -->
    <div class="command-section" id="rules-section">
      <div class="command-section-header" onclick="toggleCommandSection('rules-commands')">
        <div class="header-title">
          <i class="ph ph-scales section-icon"></i>
          <h3>Rules 명령어</h3>
        </div>
        <div class="header-controls">
          <span class="command-count" id="rules-count">0</span>
          <span class="toggle-icon ph ph-caret-down" id="rules-commands-toggle"></span>
        </div>
      </div>
      <div class="commands-container" id="rules-commands">
        <div class="empty-commands">명령어를 로드하는 중...</div>
      </div>
    </div>
    
    <!-- 명령어 세부 정보 모달 (클릭 시 표시) -->
    <div class="command-detail-modal" id="commandDetailModal">
      <div class="command-detail-content">
        <div class="command-detail-header">
          <div class="command-detail-title" id="modalCommandTitle">명령어 세부 정보</div>
          <button class="command-detail-close" id="closeModal">
            <i class="ph ph-x"></i>
          </button>
        </div>
        <div class="command-detail-body" id="modalCommandBody">
          <!-- 명령어 세부 정보가 여기에 동적으로 추가됩니다 -->
        </div>
        <div class="command-detail-footer">
          <button class="command-detail-execute" id="executeCommand">
            <i class="ph ph-play"></i>
            <span>실행</span>
          </button>
          <button class="command-detail-copy" id="copyCommand">
            <i class="ph ph-copy"></i>
            <span>복사</span>
          </button>
          <div class="command-detail-favorite">
            <button class="command-detail-star" id="toggleFavorite">
              <i class="ph ph-star"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="${iconManagerJsUri}"></script>
  <script>
    (function() {
      // VS Code API
      const vscode = acquireVsCodeApi();
      
      // 상태 관리
      let state = vscode.getState() || {
        commands: {
          system: [],    // 시스템 명령어 (/)
          git: [],       // Git 명령어 (@git:)
          doc: [],       // 문서 명령어 (@doc:)
          jira: [],      // Jira 명령어 (@jira:)
          pocket: [],    // Pocket 명령어 (@pocket:)
          vault: [],     // Vault 명령어 (@vault:)
          rules: []      // Rules 명령어 (@rules:)
        },
        favorites: [],   // 즐겨찾기 명령어 ID 목록
        showFrequentOnly: false, // 자주 사용하는 명령어만 표시할지 여부
        helpMode: false  // 도움말 모드 활성화 여부
      };
      
      // 명령어 도메인별 아이콘 및 색상 매핑
      const COMMAND_DOMAINS = {
        'system': { 
          icon: 'settings-gear', 
          color: 'var(--command-system-color)',
          title: '시스템 명령어'
        },
        'git': { 
          icon: 'git-merge', 
          color: 'var(--command-git-color)',
          title: 'Git 명령어'
        },
        'doc': { 
          icon: 'book', 
          color: 'var(--command-doc-color)',
          title: '문서 명령어'
        },
        'jira': { 
          icon: 'issues', 
          color: 'var(--command-jira-color)',
          title: 'Jira 명령어'
        },
        'pocket': { 
          icon: 'archive', 
          color: 'var(--command-pocket-color)',
          title: 'Pocket 명령어'
        },
        'vault': { 
          icon: 'database', 
          color: 'var(--command-vault-color)',
          title: 'Vault 명령어'
        },
        'rules': { 
          icon: 'law', 
          color: 'var(--command-rules-color)',
          title: 'Rules 명령어'
        }
      };
      
      // 명령어 종류별 아이콘 매핑
      const COMMAND_ICONS = {
        // Git 관련
        'commit': 'git-commit',
        'pull': 'git-pull-request',
        'push': 'arrow-up',
        'branch': 'git-branch',
        'merge': 'git-merge',
        'rebase': 'git-pull-request',
        
        // Jira 관련
        'issue': 'issue-opened',
        'ticket': 'issue-opened',
        'bug': 'bug',
        'task': 'tasklist',
        
        // 문서 관련
        'search': 'search',
        'read': 'book',
        'write': 'edit',
        'create': 'new-file',
        
        // 일반 명령어
        'build': 'rocket',
        'deploy': 'cloud-upload',
        'test': 'beaker',
        'help': 'question',
        'clear': 'clear-all',
        'settings': 'gear',
        'config': 'settings',
        'save': 'save',
        'load': 'folder-opened',
        'model': 'hubot',
        'chat': 'comment-discussion',
        'code': 'code',
        'debug': 'debug',
        'log': 'output',
        'plugin': 'package',
        'lock': 'lock',
        'unlock': 'unlock',
        'refresh': 'refresh',
        'delete': 'trash',
        'add': 'add',
        'remove': 'remove',
        'list': 'list-unordered',
        'info': 'info',
        'warning': 'warning',
        'error': 'error',
        
        // 기본 아이콘
        'default': 'terminal'
      };
      
      /**
       * 명령어 ID로부터 적절한 아이콘을 결정합니다.
       * @param {string} commandId 명령어 ID
       * @returns {string} 코디콘 아이콘 이름
       */
      function getIconForCommand(commandId) {
        if (!commandId) return COMMAND_ICONS.default;
        
        // 명령어 ID에서 주요 그룹과 명령어 추출
        const parts = commandId.split(':');
        let domain, command;
        
        if (commandId.startsWith('/')) {
          domain = 'system';
          command = parts[0].substring(1);
        } else if (commandId.startsWith('@')) {
          domain = parts[0].substring(1);
          command = parts.length > 1 ? parts[1] : '';
          
          // 하위 명령어가 있는 경우
          const subCommand = parts.length > 2 ? parts[2] : '';
          if (subCommand && COMMAND_ICONS[subCommand]) {
            return COMMAND_ICONS[subCommand];
          }
        } else {
          return COMMAND_ICONS.default;
        }
        
        // 명령어 이름에 해당하는 아이콘 찾기
        if (COMMAND_ICONS[command]) {
          return COMMAND_ICONS[command];
        }
        
        // 명령어 이름이 복합어인 경우 (예: create-issue)
        const subParts = command.split('-');
        for (const part of subParts) {
          if (COMMAND_ICONS[part]) {
            return COMMAND_ICONS[part];
          }
        }
        
        // 특정 키워드 포함 여부로 결정
        for (const [keyword, icon] of Object.entries(COMMAND_ICONS)) {
          if (command.includes(keyword)) {
            return icon;
          }
        }
        
        // 도메인에 해당하는 기본 아이콘 반환
        return COMMAND_DOMAINS[domain]?.icon || COMMAND_ICONS.default;
      }
      
      /**
       * 명령어 버튼 생성 함수
       * @param {Object} command 명령어 객체
       * @returns {HTMLElement} 버튼 컨테이너
       */
      function createCommandButton(command) {
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'command-button';
        
        // 즐겨찾기 여부 확인 및 클래스 추가
        if (state.favorites.includes(command.id)) {
          buttonContainer.classList.add('command-favorite');
        }
        
        // 도메인 결정 및 그룹 클래스 추가
        let domain = '';
        if (command.id.startsWith('@')) {
          domain = command.id.split(':')[0].substring(1);
          buttonContainer.classList.add(`command-group-${domain}`);
        } else if (command.id.startsWith('/')) {
          domain = 'system';
          buttonContainer.classList.add('command-group-system');
        }
        
        // 툴팁 설정 (도움말 모드일 때 상세 정보 포함)
        if (state.helpMode && command.syntax) {
          buttonContainer.title = `${command.description || ''}\n\n사용법: ${command.syntax}\n${command.examples ? `\n예제:\n${command.examples.join('\n')}` : ''}`;
        } else {
          buttonContainer.title = command.description || '';
        }
        
        // 명령어 버튼 생성
        const button = document.createElement('button');
        button.className = 'button-content';
        button.dataset.commandId = command.id;
        button.dataset.domain = domain;
        
        // 클릭 이벤트 - 일반 클릭은 실행, 우클릭은 세부정보
        button.onclick = function(e) {
          // 세부 정보 모달 표시 (Alt 키 누르고 클릭하면 바로 실행)
          if (!e.altKey) {
            showCommandDetail(command);
          } else {
            executeCommand(command.id);
          }
        };
        
        // 더블 클릭은 바로 명령어 실행
        button.ondblclick = function() {
          executeCommand(command.id);
        };
        
        // 아이콘 자동 결정 또는 명시적 아이콘 사용
        const iconName = command.iconName || getIconForCommand(command.id);
        const icon = document.createElement('i');
        icon.className = `codicon codicon-${iconName}`;
        button.appendChild(icon);
        
        // 레이블 추가
        const label = document.createElement('span');
        
        // 표시명 생성
        let displayName = command.id;
        if (command.id.startsWith('@')) {
          // '@git:commit' -> 'commit'
          const parts = command.id.split(':');
          if (parts.length > 1) {
            displayName = parts[1];
            // 하위 명령어가 있는 경우 (@git:commit:all -> 'commit-all')
            if (parts.length > 2) {
              displayName += `-${parts[2]}`;
            }
          }
        } else if (command.id.startsWith('/')) {
          // '/help' -> 'help'
          displayName = command.id.substring(1);
        }
        
        label.textContent = command.label || displayName;
        button.appendChild(label);
        
        buttonContainer.appendChild(button);
        return buttonContainer;
      }
      
      /**
       * 명령어 세부 정보 모달을 표시합니다.
       * @param {Object} command 명령어 객체 
       */
      function showCommandDetail(command) {
        const modal = document.getElementById('commandDetailModal');
        const modalTitle = document.getElementById('modalCommandTitle');
        const modalBody = document.getElementById('modalCommandBody');
        const executeBtn = document.getElementById('executeCommand');
        const copyBtn = document.getElementById('copyCommand');
        const favoriteBtn = document.getElementById('toggleFavorite');
        
        // 모달 제목 설정
        modalTitle.textContent = command.id;
        
        // 모달 내용 설정
        modalBody.innerHTML = '';
        
        // 설명 섹션
        if (command.description) {
          const descriptionSection = document.createElement('div');
          descriptionSection.className = 'command-detail-section';
          
          const descriptionTitle = document.createElement('div');
          descriptionTitle.className = 'command-detail-section-title';
          descriptionTitle.textContent = '설명';
          descriptionSection.appendChild(descriptionTitle);
          
          const description = document.createElement('div');
          description.className = 'command-detail-description';
          description.textContent = command.description;
          descriptionSection.appendChild(description);
          
          modalBody.appendChild(descriptionSection);
        }
        
        // 문법 섹션
        if (command.syntax) {
          const syntaxSection = document.createElement('div');
          syntaxSection.className = 'command-detail-section';
          
          const syntaxTitle = document.createElement('div');
          syntaxTitle.className = 'command-detail-section-title';
          syntaxTitle.textContent = '사용법';
          syntaxSection.appendChild(syntaxTitle);
          
          const syntax = document.createElement('div');
          syntax.className = 'command-detail-syntax';
          syntax.textContent = command.syntax;
          syntaxSection.appendChild(syntax);
          
          modalBody.appendChild(syntaxSection);
        }
        
        // 예제 섹션
        if (command.examples && command.examples.length > 0) {
          const examplesSection = document.createElement('div');
          examplesSection.className = 'command-detail-section';
          
          const examplesTitle = document.createElement('div');
          examplesTitle.className = 'command-detail-section-title';
          examplesTitle.textContent = '예제';
          examplesSection.appendChild(examplesTitle);
          
          const examplesList = document.createElement('div');
          examplesList.className = 'command-detail-examples';
          
          command.examples.forEach(example => {
            const exampleItem = document.createElement('div');
            exampleItem.className = 'command-detail-example';
            exampleItem.textContent = example;
            examplesList.appendChild(exampleItem);
          });
          
          examplesSection.appendChild(examplesList);
          modalBody.appendChild(examplesSection);
        }
        
        // 실행 버튼 설정
        executeBtn.onclick = () => {
          executeCommand(command.id);
          closeModal();
        };
        
        // 복사 버튼 설정
        copyBtn.onclick = () => {
          vscode.postMessage({
            command: 'copyToClipboard',
            text: command.id
          });
          
          // 복사 피드백 표시
          const originalText = copyBtn.querySelector('span').textContent;
          copyBtn.querySelector('span').textContent = '복사됨!';
          setTimeout(() => {
            copyBtn.querySelector('span').textContent = originalText;
          }, 1500);
        };
        
        // 즐겨찾기 버튼 설정
        const isFavorite = state.favorites.includes(command.id);
        if (isFavorite) {
          favoriteBtn.classList.add('favorite');
          favoriteBtn.querySelector('i').className = 'ph ph-star-fill';
        } else {
          favoriteBtn.classList.remove('favorite');
          favoriteBtn.querySelector('i').className = 'ph ph-star';
        }
        
        favoriteBtn.onclick = () => {
          toggleFavorite(command.id);
          
          // 버튼 상태 업데이트
          if (state.favorites.includes(command.id)) {
            favoriteBtn.classList.add('favorite');
            favoriteBtn.querySelector('i').className = 'ph ph-star-fill';
          } else {
            favoriteBtn.classList.remove('favorite');
            favoriteBtn.querySelector('i').className = 'ph ph-star';
          }
        };
        
        // 모달 표시
        modal.classList.add('visible');
      }
      
      /**
       * 모달을 닫습니다.
       */
      function closeModal() {
        const modal = document.getElementById('commandDetailModal');
        modal.classList.remove('visible');
      }
      
      /**
       * 명령어를 실행합니다.
       * @param {string} commandId 명령어 ID
       */
      function executeCommand(commandId) {
        vscode.postMessage({
          command: 'executeCommand',
          commandId: commandId
        });
      }
      
      /**
       * 명령어를 즐겨찾기에 추가하거나 제거합니다.
       * @param {string} commandId 명령어 ID
       */
      function toggleFavorite(commandId) {
        const index = state.favorites.indexOf(commandId);
        if (index === -1) {
          state.favorites.push(commandId);
        } else {
          state.favorites.splice(index, 1);
        }
        
        vscode.setState(state);
        renderCommands(); // 변경 내용 반영
      }
      
      /**
       * 명령어 카테고리 토글
       * @param {string} sectionId 카테고리 섹션 ID 
       */
      window.toggleCommandSection = function(sectionId) {
        const container = document.getElementById(sectionId);
        const toggleIcon = document.getElementById(`${sectionId}-toggle`);
        
        if (container.classList.contains('collapsed')) {
          container.classList.remove('collapsed');
          toggleIcon.classList.remove('collapsed');
        } else {
          container.classList.add('collapsed');
          toggleIcon.classList.add('collapsed');
        }
      };
      
      /**
       * 자주 사용하는 명령어 필터링 상태를 토글합니다.
       */
      function toggleFrequentMode() {
        state.showFrequentOnly = !state.showFrequentOnly;
        vscode.setState(state);
        
        // 버튼 상태 업데이트
        const toggleBtn = document.getElementById('toggleFrequent');
        if (state.showFrequentOnly) {
          toggleBtn.classList.add('active');
        } else {
          toggleBtn.classList.remove('active');
        }
        
        renderCommands();
      }
      
      /**
       * 도움말 모드를 토글합니다.
       */
      function toggleHelpMode() {
        state.helpMode = !state.helpMode;
        vscode.setState(state);
        
        // 버튼 상태 업데이트
        const toggleBtn = document.getElementById('toggleHelpMode');
        if (state.helpMode) {
          toggleBtn.classList.add('active');
        } else {
          toggleBtn.classList.remove('active');
        }
        
        renderCommands();
      }
      
      /**
       * 검색 필드를 지웁니다.
       */
      function clearSearch() {
        const searchInput = document.getElementById('commandSearch');
        searchInput.value = '';
        
        // 검색 필터링 다시 실행
        const event = new Event('input');
        searchInput.dispatchEvent(event);
      }
      
      /**
       * 모든 명령어를 새로고침합니다.
       */
      function refreshCommands() {
        // VS Code에 명령어 목록 요청
        vscode.postMessage({
          command: 'getCommands'
        });
        
        // 새로고침 아이콘 회전 애니메이션
        const refreshBtn = document.getElementById('refreshCommands');
        refreshBtn.classList.add('rotating');
        setTimeout(() => {
          refreshBtn.classList.remove('rotating');
        }, 1000);
      }
      
      /**
       * 명령어 목록을 화면에 렌더링합니다.
       */
      function renderCommands() {
        // 자주 사용하는 명령어 렌더링
        const frequentContainer = document.getElementById('frequent-commands');
        frequentContainer.innerHTML = '';
        
        // 즐겨찾기 명령어 수집
        let favoriteCommands = [];
        for (const domain in state.commands) {
          state.commands[domain].forEach(cmd => {
            if (state.favorites.includes(cmd.id)) {
              favoriteCommands.push(cmd);
            }
          });
        }
        
        if (favoriteCommands.length > 0) {
          favoriteCommands.forEach(cmd => {
            frequentContainer.appendChild(createCommandButton(cmd));
          });
          // 수량 표시 업데이트
          document.getElementById('frequent-count').textContent = favoriteCommands.length;
        } else {
          const emptyMsg = document.createElement('div');
          emptyMsg.className = 'empty-commands';
          emptyMsg.textContent = '자주 사용하는 명령어가 없습니다.';
          frequentContainer.appendChild(emptyMsg);
          document.getElementById('frequent-count').textContent = '0';
        }
        
        // 자주 사용하는 명령어만 표시 모드인 경우 다른 섹션은 생략
        if (state.showFrequentOnly) {
          document.getElementById('system-section').style.display = 'none';
          document.getElementById('git-section').style.display = 'none';
          document.getElementById('doc-section').style.display = 'none';
          document.getElementById('jira-section').style.display = 'none';
          document.getElementById('pocket-section').style.display = 'none';
          document.getElementById('vault-section').style.display = 'none';
          document.getElementById('rules-section').style.display = 'none';
          return;
        } else {
          document.getElementById('system-section').style.display = 'flex';
          document.getElementById('git-section').style.display = 'flex';
          document.getElementById('doc-section').style.display = 'flex';
          document.getElementById('jira-section').style.display = 'flex';
          document.getElementById('pocket-section').style.display = 'flex';
          document.getElementById('vault-section').style.display = 'flex';
          document.getElementById('rules-section').style.display = 'flex';
        }
        
        // 시스템 명령어 렌더링
        const systemContainer = document.getElementById('system-commands');
        systemContainer.innerHTML = '';
        if (state.commands.system.length > 0) {
          state.commands.system.forEach(cmd => {
            systemContainer.appendChild(createCommandButton(cmd));
          });
          document.getElementById('system-count').textContent = state.commands.system.length;
        } else {
          const emptyMsg = document.createElement('div');
          emptyMsg.className = 'empty-commands';
          emptyMsg.textContent = '시스템 명령어가 없습니다.';
          systemContainer.appendChild(emptyMsg);
          document.getElementById('system-count').textContent = '0';
        }
        
        // Git 명령어 렌더링
        const gitContainer = document.getElementById('git-commands');
        gitContainer.innerHTML = '';
        if (state.commands.git.length > 0) {
          state.commands.git.forEach(cmd => {
            gitContainer.appendChild(createCommandButton(cmd));
          });
          document.getElementById('git-count').textContent = state.commands.git.length;
        } else {
          const emptyMsg = document.createElement('div');
          emptyMsg.className = 'empty-commands';
          emptyMsg.textContent = 'Git 명령어가 없습니다.';
          gitContainer.appendChild(emptyMsg);
          document.getElementById('git-count').textContent = '0';
        }
        
        // 문서 명령어 렌더링
        const docContainer = document.getElementById('doc-commands');
        docContainer.innerHTML = '';
        if (state.commands.doc.length > 0) {
          state.commands.doc.forEach(cmd => {
            docContainer.appendChild(createCommandButton(cmd));
          });
          document.getElementById('doc-count').textContent = state.commands.doc.length;
        } else {
          const emptyMsg = document.createElement('div');
          emptyMsg.className = 'empty-commands';
          emptyMsg.textContent = '문서 명령어가 없습니다.';
          docContainer.appendChild(emptyMsg);
          document.getElementById('doc-count').textContent = '0';
        }
        
        // Jira 명령어 렌더링
        const jiraContainer = document.getElementById('jira-commands');
        jiraContainer.innerHTML = '';
        if (state.commands.jira.length > 0) {
          state.commands.jira.forEach(cmd => {
            jiraContainer.appendChild(createCommandButton(cmd));
          });
          document.getElementById('jira-count').textContent = state.commands.jira.length;
        } else {
          const emptyMsg = document.createElement('div');
          emptyMsg.className = 'empty-commands';
          emptyMsg.textContent = 'Jira 명령어가 없습니다.';
          jiraContainer.appendChild(emptyMsg);
          document.getElementById('jira-count').textContent = '0';
        }
        
        // Pocket 명령어 렌더링
        const pocketContainer = document.getElementById('pocket-commands');
        pocketContainer.innerHTML = '';
        if (state.commands.pocket.length > 0) {
          state.commands.pocket.forEach(cmd => {
            pocketContainer.appendChild(createCommandButton(cmd));
          });
          document.getElementById('pocket-count').textContent = state.commands.pocket.length;
        } else {
          const emptyMsg = document.createElement('div');
          emptyMsg.className = 'empty-commands';
          emptyMsg.textContent = 'Pocket 명령어가 없습니다.';
          pocketContainer.appendChild(emptyMsg);
          document.getElementById('pocket-count').textContent = '0';
        }
        
        // Vault 명령어 렌더링
        const vaultContainer = document.getElementById('vault-commands');
        vaultContainer.innerHTML = '';
        if (state.commands.vault.length > 0) {
          state.commands.vault.forEach(cmd => {
            vaultContainer.appendChild(createCommandButton(cmd));
          });
          document.getElementById('vault-count').textContent = state.commands.vault.length;
        } else {
          const emptyMsg = document.createElement('div');
          emptyMsg.className = 'empty-commands';
          emptyMsg.textContent = 'Vault 명령어가 없습니다.';
          vaultContainer.appendChild(emptyMsg);
          document.getElementById('vault-count').textContent = '0';
        }
        
        // Rules 명령어 렌더링
        const rulesContainer = document.getElementById('rules-commands');
        rulesContainer.innerHTML = '';
        if (state.commands.rules.length > 0) {
          state.commands.rules.forEach(cmd => {
            rulesContainer.appendChild(createCommandButton(cmd));
          });
          document.getElementById('rules-count').textContent = state.commands.rules.length;
        } else {
          const emptyMsg = document.createElement('div');
          emptyMsg.className = 'empty-commands';
          emptyMsg.textContent = 'Rules 명령어가 없습니다.';
          rulesContainer.appendChild(emptyMsg);
          document.getElementById('rules-count').textContent = '0';
        }
      }
      
      /**
       * 명령어 검색 필터링
       * @param {Event} event 입력 이벤트 
       */
      function filterCommands(event) {
        const searchText = event.target.value.toLowerCase();
        const allButtons = document.querySelectorAll('.command-button');
        
        // 검색어가 있으면 클리어 버튼 표시
        document.getElementById('clearSearch').style.display = searchText ? 'flex' : 'none';
        
        // 각 명령어 버튼 필터링
        allButtons.forEach(button => {
          const commandText = button.querySelector('button').dataset.commandId.toLowerCase();
          const descriptionText = button.title.toLowerCase();
          
          if (commandText.includes(searchText) || descriptionText.includes(searchText)) {
            button.style.display = 'block';
          } else {
            button.style.display = 'none';
          }
        });
        
        // 비어있는 섹션 처리
        document.querySelectorAll('.commands-container').forEach(container => {
          const visibleButtons = Array.from(container.querySelectorAll('.command-button')).filter(btn => 
            btn.style.display !== 'none'
          ).length;
          
          const emptyMessage = container.querySelector('.empty-commands');
          
          if (visibleButtons === 0) {
            if (!emptyMessage) {
              const newEmptyMsg = document.createElement('div');
              newEmptyMsg.className = 'empty-commands';
              newEmptyMsg.textContent = '일치하는 명령어가 없습니다.';
              container.appendChild(newEmptyMsg);
            } else if (emptyMessage) {
              emptyMessage.textContent = '일치하는 명령어가 없습니다.';
            }
          } else if (emptyMessage) {
            emptyMessage.remove();
          }
        });
        
        // 도메인별 카운트 업데이트
        updateDomainCounts();
      }
      
      /**
       * 각 도메인별 현재 표시 중인 명령어 수를 업데이트합니다.
       */
      function updateDomainCounts() {
        const domains = ['frequent', 'system', 'git', 'doc', 'jira', 'pocket', 'vault', 'rules'];
        
        domains.forEach(domain => {
          const container = document.getElementById(`${domain}-commands`);
          const visibleButtons = Array.from(container.querySelectorAll('.command-button')).filter(btn => 
            btn.style.display !== 'none'
          ).length;
          
          document.getElementById(`${domain}-count`).textContent = visibleButtons;
        });
      }
      
      /**
       * 이벤트 리스너 설정
       */
      function setupEventListeners() {
        // 검색 필드 이벤트
        document.getElementById('commandSearch').addEventListener('input', filterCommands);
        document.getElementById('clearSearch').addEventListener('click', clearSearch);
        
        // 액션 버튼 이벤트
        document.getElementById('toggleFrequent').addEventListener('click', toggleFrequentMode);
        document.getElementById('refreshCommands').addEventListener('click', refreshCommands);
        document.getElementById('toggleHelpMode').addEventListener('click', toggleHelpMode);
        
        // 모달 닫기 버튼 이벤트
        document.getElementById('closeModal').addEventListener('click', closeModal);
        
        // 모달 바깥쪽 클릭시 닫기
        document.getElementById('commandDetailModal').addEventListener('click', function(e) {
          if (e.target === this) {
            closeModal();
          }
        });
        
        // ESC 키를 눌렀을 때 모달 닫기
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            closeModal();
          }
        });
      }
      
      /**
       * 명령어 도메인 그룹을 가져옵니다.
       * @param {string} commandId 명령어 ID
       * @returns {string} 도메인 키
       */
      function getDomainForCommand(commandId) {
        if (commandId.startsWith('/')) {
          return 'system';
        } else if (commandId.startsWith('@')) {
          const domain = commandId.split(':')[0].substring(1);
          return domain;
        }
        return '';
      }
      
      // VS Code로부터 메시지 수신
      window.addEventListener('message', event => {
        const message = event.data;
        
        switch (message.command) {
          case 'updateCommands':
            // 명령어 목록을 업데이트 (전체)
            if (message.commands && Array.isArray(message.commands)) {
              // 명령어 그룹별 분류
              const systemCommands = [];
              const gitCommands = [];
              const docCommands = [];
              const jiraCommands = [];
              const pocketCommands = [];
              const vaultCommands = [];
              const rulesCommands = [];
              
              message.commands.forEach(cmd => {
                if (cmd.id.startsWith('/')) {
                  systemCommands.push(cmd);
                } else if (cmd.id.startsWith('@git:')) {
                  gitCommands.push(cmd);
                } else if (cmd.id.startsWith('@doc:')) {
                  docCommands.push(cmd);
                } else if (cmd.id.startsWith('@jira:')) {
                  jiraCommands.push(cmd);
                } else if (cmd.id.startsWith('@pocket:')) {
                  pocketCommands.push(cmd);
                } else if (cmd.id.startsWith('@vault:')) {
                  vaultCommands.push(cmd);
                } else if (cmd.id.startsWith('@rules:')) {
                  rulesCommands.push(cmd);
                }
              });
              
              // 명령어 저장 및 렌더링
              state.commands = {
                system: systemCommands,
                git: gitCommands,
                doc: docCommands,
                jira: jiraCommands,
                pocket: pocketCommands,
                vault: vaultCommands,
                rules: rulesCommands
              };
              
              vscode.setState(state);
              renderCommands();
            }
            break;
            
          case 'updatePluginCommands':
            // 특정 플러그인 명령어만 업데이트
            if (message.pluginId && message.commands && Array.isArray(message.commands)) {
              // 플러그인 ID에 따라 해당 도메인의 명령어 업데이트
              const domain = message.pluginId;
              if (state.commands[domain] !== undefined) {
                state.commands[domain] = message.commands;
                vscode.setState(state);
                renderCommands();
              }
            }
            break;
            
          case 'commandExecuted':
            // 명령어 실행 완료 알림
            const commandId = message.commandId;
            const success = message.success;
            
            // 명령어 실행 결과 피드백
            if (success) {
              // 성공 피드백 (예: 버튼 잠시 강조)
              const buttons = document.querySelectorAll(`button[data-command-id="${commandId}"]`);
              buttons.forEach(button => {
                button.classList.add('executed-success');
                setTimeout(() => {
                  button.classList.remove('executed-success');
                }, 1500);
              });
            } else {
              // 실패 피드백
              const buttons = document.querySelectorAll(`button[data-command-id="${commandId}"]`);
              buttons.forEach(button => {
                button.classList.add('executed-error');
                setTimeout(() => {
                  button.classList.remove('executed-error');
                }, 1500);
              });
            }
            break;
            
          default:
            console.log('처리되지 않은 메시지 타입:', message.command);
        }
      });
      
      /**
       * 초기화 함수
       * 페이지 로드 시 실행
       */
      function initialize() {
        // 이벤트 리스너 설정
        setupEventListeners();
        
        // 클리어 버튼 초기 상태 설정
        document.getElementById('clearSearch').style.display = 'none';
        
        // 토글 버튼 초기 상태 설정
        document.getElementById('toggleFrequent').classList.toggle('active', state.showFrequentOnly);
        document.getElementById('toggleHelpMode').classList.toggle('active', state.helpMode);
        
        // 기존 상태에 명령어가 있으면 렌더링
        let hasCommands = false;
        Object.keys(state.commands).forEach(domain => {
          if (state.commands[domain].length > 0) {
            hasCommands = true;
          }
        });
        
        if (hasCommands) {
          renderCommands();
        }
        
        // VS Code에 명령어 목록 요청
        vscode.postMessage({
          command: 'getCommands'
        });
      }
      
      // 초기화 실행
      initialize();
    })();
  </script>
</body>
</html>